<riw-global-toast />
<p-confirmPopup key="inline" />
<p-confirmDialog key="dialog"/>

<ng-container *ngIf="useDial">
  <div id="ddOverlay" [draggable]="true" (dragstart)="dialDragStart($event)" (dragend)="dialDragEnd($event)"
       class="menu-dial menu-dial-overlay"
       (click)="dialOverlayClickthru($event)"></div>
  <p-speedDial #speedDial id="speedDial" [model]="getDialItems()" direction="down" type="linear" class="menu-dial"
                (onHide)="isDialOpen = false" (onShow)="isDialOpen = true"/>
</ng-container>

<ng-container *ngIf="!useDial">
<div class="fixed-toolbar">
  <p-progressBar [mode]="things.loading ? 'indeterminate' : 'determinate'" class="loading-bar" />
  <div class="toolbar-content">
    <div class="toolbar-left">
      <!-- TODO Have the option to "quick fill" a Template that has been marked as "Pinned", which means it will show up on the toolbar, and be a 1-click and 1-fill of a field to quickly enter things. Example would be Reminder/Note, Work Commute, etc. Something repetitive that you don't want to have to keep manually re-entering -->
      <!-- TODO When refreshing our data we should clear our filters, or fix them to re-apply, as currently the content resets and all rows are shown -->
      <p-button (onClick)="things.getAllThings()" icon="pi pi-refresh" [loading]="things.loading" severity="info" />
      <p-button (onClick)="clearSelectedRows(); manageTemplate.show()" icon="pi pi-list" [label]="getManageTemplateLabel()" />
      <p-button (onClick)="clearSelectedRows(); manageThing.showAdd()" icon="pi pi-plus-circle" label="New Thing" />
      <p-button (onClick)="requestEditSelected()" icon="pi pi-pencil" label="Edit Thing" [disabled]="!hasOneSelectedRow()" />
      <p-button (onClick)="confirmDeleteSelected($event)" icon="pi pi-trash" severity="danger" [label]="getDeleteLabel()" [disabled]="!hasSelectedRows()" />
    </div>
    <div class="toolbar-right">
      <!-- TODO Get Utility.plural and similar functions accessible from Angular templates -->
      <p-splitButton (onClick)="toggleShowReminders()"
                     icon="pi pi-clock" [model]="getRemindersForSplitButton()"
                     [label]="getReminderLabel()"
                     *ngIf="things.hasAnyReminders()"
                     class="reminder-button" styleClass="p-button-secondary p-button-sm"/>
      <!-- TODO Handle a flag for if we're mobile or not (which just means we're at a set CSS breakpoint, not related to browser string) -->
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input pInputText type="text" (input)="globalFilterTableByEvent($event)" placeholder="Search Things" />
      </span>
      <p-progressSpinner *ngIf="things.loading" />
    </div>
  </div>
</div>
</ng-container>

<div [class]="'main-wrap' + (useDial ? '' : ' main-wrap-with-toolbar')">

<!-- TODO Have a way to automatically clean up Reminders, done in the Node service itself, which will automatically strip the reminder flag if the time is passed. Don't worry about timezones for now -->
<div id="reminders" class="reminder-wrap" *ngIf="showReminders">
  <riw-reminder-message *ngFor="let reminder of things.remindersOverdue" [thing]="reminder" [overdue]="true" (onClick)="handleOverdueReminder($event)" />
  <riw-reminder-message *ngFor="let reminder of things.reminders" [thing]="reminder" (onClick)="requestEditReminder($event)" />
</div>

<p-table #thingTable *ngIf="things.loadedAndHasData()"
         [value]="things.data" [loading]="things.loading"
         class="thing-table" styleClass="p-datatable-striped"
         selectionMode="multiple" [(selection)]="selectedRows"
         (sortFunction)="customSort($event)" [customSort]="true"
         sortField="time" [sortOrder]="-1"
         [globalFilterFields]="['name', 'time', 'templateType']"
         [paginator]="true" [rows]="50"
         [pageLinks]="3" [alwaysShowPaginator]="false" [showFirstLastIcon]="false" [showCurrentPageReport]="true"
         [scrollable]="true" [scrollHeight]="tableScrollHeight"
         >
         <!-- TODO Make 'scrollable' a user option, and tweak related calculations and style? -->
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="name" class="name-col">
        <span class="pi pi-refresh header-refresh" (click)="things.getAllThings()" pTooltip="Refresh" *ngIf="useDial">&nbsp;</span>
        {{ getNameColumnHeader() }} <p-sortIcon field="name" />
      </th>
      <th pSortableColumn="templateType" class="type-col">Type <p-sortIcon field="templateType" /></th>
      <th pSortableColumn="time" class="time-col">Date <p-sortIcon field="time" /></th>
      <th pSortableColumn="fields" class="fields-col">
        Fields
        <p-sortIcon field="fields" />
      </th>
      <th class="control-col">
        {{ rowSelectedCount() }} Sel<span class="hide-on-mobile">ected Rows</span> <!-- TODO Plural -->
        <!-- TODO Put these simple and small clickable icons into a component as they're used a few places -->
        <span class="pi pi-ban header-tiny-button header-tiny-button-color header-clear-rows-button" (click)="clearSelectedRows()" pTooltip="Clear Selections" tooltipPosition="left" *ngIf="hasSelectedRows()"></span>
        &nbsp;
        <span class="pi pi-filter header-tiny-button header-tiny-button-color" (click)="toggleShowFilters()" pTooltip="Show Filters" *ngIf="!showFilters"></span>
        <span class="pi pi-filter-slash header-tiny-button header-tiny-button-color" (click)="toggleShowFilters()" pTooltip="Hide Filters" *ngIf="showFilters"></span>
      </th>
    </tr>
    <ng-container *ngIf="showFilters">
      <tr>
        <th><p-columnFilter type="text" field="name" matchMode="contains" /></th>
        <th><p-columnFilter type="text" field="templateType" matchMode="contains" /></th>
        <!-- TODO Could add a custom filter option of "Reminder=true/false" for the time column -->
        <th><p-columnFilter type="date" field="time" appendTo="body" /></th>
        <th colspan="2">
          <input pInputText type="text" (change)="filterFields($event)" class="header-filter-field" />
        </th>
      </tr>
    </ng-container>
  </ng-template>
  <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
    <tr [pSelectableRow]="data" [pSelectableRowIndex]="rowIndex">
      <td>
        <span [style]="'color:' + data.color">{{ data.name }}</span>
      </td>
      <td>
        <span [style]="'color:' + data.color">{{ data.templateType }}</span>
      </td>
      <td class="center">
        <span [style]="'color:' + data.color">
          <span class="pi pi-clock" *ngIf="data.hasFutureReminder()" pTooltip="Thing is a Reminder"></span> {{ data.time | date: 'MMM dd &rsquo;yy \'at\' hh:mm a' }}
        </span>
      </td>
      <td colspan="2">
        {{ data.getFieldsAsString() }}
      </td>
    </tr>
  </ng-template>
  <ng-template *ngIf="!things.loading" pTemplate="emptymessage" let-columns>
    <tr>
      <td colspan="5" class="center">
        No data matches your search
      </td>
    </tr>
  </ng-template>
</p-table>

<div *ngIf="!things.loadedAndHasData()" class="no-things-wrap">
  <span *ngIf="!things.loading">
    <!-- TODO If we have a speed dial, we should just put Add Thing / Template button here as well, to simplify for the user -->
    <!-- TODO More verbose message too, some basic instructions and description of app, etc. -->
    Add something to get started
  </span>
</div>

</div>

<riw-manage-thing-dialog #manageThing (manageTemplateEvent)="manageTemplate.show($event)" (onDelete)="confirmDeleteThing($event)"/>
<riw-manage-template-dialog #manageTemplate />
<riw-global-search-dialog #globalSearch [searchFunction]="globalFilterTable.bind(this)"/>
