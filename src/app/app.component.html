<riw-global-toast />

<div class="fixed-toolbar">
  <p-progressBar [mode]="things.loading ? 'indeterminate' : 'determinate'" class="loading-bar" />
  <div class="toolbar-content">
    <div class="toolbar-left">
      <!-- TODO Have the option to "quick fill" a Template that has been marked as "Pinned", which means it will show up on the toolbar, and be a 1-click and 1-fill of a field to quickly enter things. Example would be Reminder/Note, Work Commute, etc. Something repetitive that you don't want to have to keep manually re-entering -->
      <!-- TODO When refreshing our data we should clear our filters, or fix them to re-apply, as currently the content resets and all rows are shown -->
      <!-- TODO Instead of the dynamicLabel approach, perhaps just use a Speed Dial PrimeNG component on mobile for buttons? Could float in top right, don't even need the toolbar -->
      <p-button (onClick)="things.getAllThings()" icon="pi pi-refresh" [loading]="things.loading" severity="info" />
      <p-button (onClick)="clearSelectedRows(); manageTemplate.show()" icon="pi pi-list" [label]="dynamicLabel('Manage ' + templateService.getTemplateCount() + ' Templates')" />
      <p-button (onClick)="clearSelectedRows(); manageThing.showAdd()" icon="pi pi-plus-circle" [label]="dynamicLabel('New Thing')" />
      <p-button (onClick)="requestEditRow(manageThing)" icon="pi pi-pencil" [label]="dynamicLabel('Edit Thing')" [disabled]="!hasOneSelectedRow()" />
      <p-button (onClick)="confirmDeleteSelected($event)" icon="pi pi-trash" [label]="getDeleteLabel()" [disabled]="!hasSelectedRows()" />
      <p-confirmPopup />
    </div>
    <div class="toolbar-right">
      <!-- TODO Get Utility.plural and similar functions accessible from Angular templates -->
      <p-splitButton (onClick)="toggleShowReminders()"
                    icon="pi pi-clock" [model]="getRemindersForSplitButton()"
                    [label]="getReminderLabel()"
                    *ngIf="things.hasReminders()"
                    class="reminder-button" styleClass="p-button-secondary p-button-sm"/>
      <!-- TODO Handle a flag for if we're mobile or not, which just means we're at a set CSS breakpoint, not related to browser string -->
      <!-- TODO Convert global search into an icon button and dialog input on mobile -->
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input pInputText type="text" (input)="globalFilterTable($event)" placeholder="Search Things" />
      </span>
      <p-progressSpinner *ngIf="things.loading" />
    </div>
  </div>
</div>

<div class="main-wrap">

<!-- TODO Have a way to automatically clean up Reminders, done in the Node service itself, which will automatically strip the reminder flag if the time is passed. Don't worry about timezones for now -->
<ng-container *ngIf="showReminders">
  <riw-reminder-message *ngFor="let reminder of things.reminders" [thing]="reminder" />
</ng-container>

<p-table #thingTable *ngIf="things.loadedAndHasData()"
         [value]="things.data" [loading]="things.loading"
         class="thing-table" styleClass="p-datatable-striped"
         selectionMode="multiple" [(selection)]="selectedRows"
         (sortFunction)="customSort($event)" [customSort]="true"
         sortField="time" [sortOrder]="-1"
         [globalFilterFields]="['name', 'time', 'templateType']"
         [paginator]="true" [rows]="100"
         [pageLinks]="3" [alwaysShowPaginator]="false" [showFirstLastIcon]="false" [showCurrentPageReport]="true">
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="name" class="name-col" >Name ({{things.data.length}}) <p-sortIcon field="name" /></th>
      <th pSortableColumn="templateType" class="type-col">Type <p-sortIcon field="templateType" /></th>
      <th pSortableColumn="time" class="time-col">Date <p-sortIcon field="time" /></th>
      <th pSortableColumn="fields" class="fields-col">Fields <p-sortIcon field="fields" /></th>
    </tr>
    <tr>
      <th><p-columnFilter type="text" field="name" matchMode="contains" /></th>
      <th><p-columnFilter type="text" field="templateType" matchMode="contains" /></th>
      <!-- TODO Could add a custom filter option of "Reminder=true/false" for the time column -->
      <th><p-columnFilter type="date" field="time" appendTo="body" /></th>
      <th><input pInputText type="text" (change)="filterFields($event)" style="height: 30px;" /></th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
    <tr [pSelectableRow]="data" [pSelectableRowIndex]="rowIndex">
      <td>
        <span [style]="'color:' + data.color">{{ data.name }}</span>
      </td>
      <td>
        <span [style]="'color:' + data.color">{{ data.templateType }}</span>
      </td>
      <td class="center">
        <span [style]="'color:' + data.color">
          <span class="pi pi-clock" *ngIf="data.hasFutureReminder()" pTooltip="Thing is a Reminder"></span> {{ data.time | date: 'MMM dd &rsquo;yy \'at\' hh:mm a' }}
        </span>
      </td>
      <td>{{ data.getFieldsAsString() }}</td>
    </tr>
  </ng-template>
  <ng-template *ngIf="!things.loading" pTemplate="emptymessage" let-columns>
    <tr>
      <td colspan="4" class="center">
        No data matches your query
      </td>
    </tr>
  </ng-template>
</p-table>

<div *ngIf="!things.loadedAndHasData()" class="no-things-wrap">
  <span *ngIf="!things.loading">
    Add something to get started
  </span>
</div>

</div>

<riw-manage-thing-dialog #manageThing (manageTemplateEvent)="manageTemplate.show($event)" />
<riw-manage-template-dialog #manageTemplate />